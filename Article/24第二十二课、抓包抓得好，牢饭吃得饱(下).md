![](_assets_24/c64c33e20b330e6fa3c40a816a2381b77908.png)  
# ä¸€ã€è¯¾ç¨‹ç›®æ ‡  
1.äº†è§£hookæŠ“åŒ…ä¸æ··æ·†å¯¹æŠ—  
2.äº†è§£åº•å±‚ç½‘ç»œè‡ªå  
3.äº†è§£ebpfæŠ“åŒ…  
4.ç®€å•å®æˆ˜åŠ è§£å¯†åè®®  
# äºŒã€å·¥å…·  
  
1.æ•™ç¨‹Demo  
2.r0capture&ecapture  
3.Reqable  
4.wireshark  
# ä¸‰ã€è¯¾ç¨‹å†…å®¹  
## 1.HookæŠ“åŒ…&&å…³é”®å®šä½&&æ··æ·†å¯¹æŠ—  
Hook æŠ“åŒ…æ˜¯ä¸€ç§æˆªå–åº”ç”¨ç¨‹åºæ•°æ®åŒ…çš„æ–¹æ³•ï¼Œé€šè¿‡ Hook åº”ç”¨æˆ–ç³»ç»Ÿå‡½æ•°æ¥è·å–æ•°æ®æµã€‚åœ¨åº”ç”¨å±‚ Hook æ—¶ï¼Œé€šè¿‡æŸ¥æ‰¾è§¦å‘è¯·æ±‚çš„å‡½æ•°æ¥æŠ“åŒ…ï¼Œä¼˜ç‚¹æ˜¯ä¸å—é˜²æŠ“åŒ…æ‰‹æ®µå½±å“ï¼Œç¼ºç‚¹æ˜¯æŠ“åŒ…æ•°æ®ä¸ä¾¿äºæˆ‘ä»¬åˆ†æå’Œç­›é€‰ã€‚  
`å¸¸è§å®‰å“ç½‘ç»œå¼€å‘æ¡†æ¶`  
  
| æ¡†æ¶åç§°               | æè¿°                                                                        | GitHub åœ°å€                                                                                                            |  
| ------------------ | ------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |  
| Volley             | ç”±Googleå¼€æºçš„è½»é‡çº§ç½‘ç»œåº“ï¼Œæ”¯æŒç½‘ç»œè¯·æ±‚å¤„ç†ã€å°å›¾ç‰‡çš„å¼‚æ­¥åŠ è½½å’Œç¼“å­˜ç­‰åŠŸèƒ½                                  | [https://github.com/google/volley](https://github.com/google/volley)                                                 |  
| Android-async-http | åŸºäºApache HttpClientçš„ä¸€ä¸ªå¼‚æ­¥ç½‘ç»œè¯·æ±‚å¤„ç†åº“                                           | [https://github.com/android-async-http/android-async-http](https://github.com/android-async-http/android-async-http) |  
| xUtils             | ç±»ä¼¼äºAfinalï¼Œä½†è¢«è®¤ä¸ºæ˜¯Afinalçš„ä¸€ä¸ªå‡çº§ç‰ˆï¼Œæä¾›äº†HTTPè¯·æ±‚çš„æ”¯æŒ                                  | [https://github.com/wyouflf/xUtils3](https://github.com/wyouflf/xUtils3)                                             |  
| OkHttp             | ä¸€ä¸ªé«˜æ€§èƒ½çš„ç½‘ç»œæ¡†æ¶ï¼Œå·²ç»è¢«Googleå®˜æ–¹è®¤å¯ï¼Œåœ¨Android 6.0ä¸­åº•å±‚æºç å·²ç»ä½¿ç”¨äº†OkHttpæ¥æ›¿ä»£HttpURLConnection | [https://github.com/square/okhttp](https://github.com/square/okhttp)                                                 |  
| Retrofit           | æä¾›äº†ä¸€ç§ç±»å‹å®‰å…¨çš„HTTPå®¢æˆ·ç«¯æ¥å£ï¼Œç®€åŒ–äº†HTTPè¯·æ±‚çš„ç¼–å†™ï¼Œé€šå¸¸ä¸OkHttpé…åˆä½¿ç”¨                            | [https://github.com/square/retrofit](https://github.com/square/retrofit)                                             |  

[ã€è¯‘ã€‘OkHttp3 æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰](https://www.cnblogs.com/liyutian/p/9489016.html)  
æ‹¦æˆªå™¨æ˜¯ OkHttp æä¾›çš„å¯¹ Http è¯·æ±‚å’Œå“åº”è¿›è¡Œç»Ÿä¸€å¤„ç†çš„å¼ºå¤§æœºåˆ¶ï¼Œå®ƒå¯ä»¥å®ç°ç½‘ç»œç›‘å¬ã€è¯·æ±‚ä»¥åŠå“åº”é‡å†™ã€è¯·æ±‚å¤±è´¥å……å®ç­‰åŠŸèƒ½ã€‚  
OkHttp ä¸­çš„ Interceptor å°±æ˜¯å…¸å‹çš„è´£ä»»é“¾çš„å®ç°ï¼Œå®ƒå¯ä»¥è®¾ç½®ä»»æ„æ•°é‡çš„ Intercepter æ¥å¯¹ç½‘ç»œè¯·æ±‚åŠå…¶å“åº”åšä»»ä½•ä¸­é—´å¤„ç†ï¼Œæ¯”å¦‚è®¾ç½®ç¼“å­˜ï¼ŒHttpsè¯ä¹¦è®¤è¯ï¼Œç»Ÿä¸€å¯¹è¯·æ±‚åŠ å¯†/é˜²ç¯¡æ”¹ç¤¾ä¼šï¼Œæ‰“å°logï¼Œè¿‡æ»¤è¯·æ±‚ç­‰ç­‰ã€‚  
OkHttp ä¸­çš„æ‹¦æˆªå™¨åˆ†ä¸º Application Interceptorï¼ˆåº”ç”¨æ‹¦æˆªå™¨ï¼‰ å’Œ NetWork Interceptorï¼ˆç½‘ç»œæ‹¦æˆªå™¨ï¼‰ä¸¤ç§  
- Network Interceptorï¼ˆç½‘ç»œæ‹¦æˆªå™¨ï¼‰  
    é€šè¿‡è°ƒç”¨ OkHttpClient.Builder çš„ addNetworkInterceptor() æ–¹æ³•æ¥æ³¨å†Œç½‘ç»œæ‹¦æˆªå™¨  
```java  
OkHttpClient client = new OkHttpClient.Builder()  
    .addNetworkInterceptor(new LoggingInterceptor())  
    .build();  
  
Request request = new Request.Builder()  
    .url("https://www.52pojie.cn/")  
    .header("User-Agent", "OkHttp Example")  
    .build();  
  
Response response = client.newCall(request).execute();  
response.body().close();  
```  
å‚è€ƒé¡¹ç›®:  
[OkHttpLogger-Frida](https://github.com/siyujie/OkHttpLogger-Frida)  
`æºç è§£æ:`  
[å®šä½OkHttpClientå…³é”®ç‚¹](https://github.com/siyujie/okhttp_find/blob/dc69bb2faebb45ba803dc3389bdfdc22bf584e34/librarys/src/main/java/com/singleman/okhttp/OkHttpFinder.java#L68)  
```java  
/**  
 * æŸ¥æ‰¾å¹¶é…ç½®OkHttpClientçš„Clientå’ŒBuilderç±»ã€‚  
 * è¯¥æ–¹æ³•é€šè¿‡åå°„æ‰«ææŒ‡å®šç±»çš„å­—æ®µå’Œæ–¹æ³•æ¥ç¡®å®šå…¶æ˜¯å¦ç¬¦åˆOkHttpClientçš„ç»“æ„ç‰¹å¾ã€‚  
 * å¦‚æœæ‰¾åˆ°ç¬¦åˆçš„ç±»ï¼Œåˆ™ä¼šè¿›ä¸€æ­¥é…ç½®å’Œæ³¨å…¥ç›¸å…³æ‹¦æˆªå™¨ã€‚  
 *  
 * @param classes   å½“å‰æ‰«æçš„ç±»  
 * @param className ç±»åï¼Œç”¨äºæŸ¥æ‰¾å’Œè°ƒè¯•  
 */  
private void findClientAndBuilderAndBuildAnd(Class classes, String className) {  
    try {  
        // ç¡®è®¤ç±»æ˜¯finalä¸”é™æ€  
        if (Modifier.isFinal(classes.getModifiers())  
                && Modifier.isStatic(classes.getModifiers())) {  
  
            int listCount = 0;         // è®°å½•Listç±»å‹å­—æ®µçš„æ•°é‡  
            int finalListCount = 0;    // è®°å½•finalä¿®é¥°çš„Listå­—æ®µæ•°é‡  
            int listInterfaceCount = 0;// è®°å½•Listä¸­åŒ…å«æ¥å£çš„å­—æ®µæ•°é‡  
            Field[] fields = classes.getDeclaredFields();  
            Field.setAccessible(fields, true); // è®¾ç½®å­—æ®µè®¿é—®æƒé™  
  
            for (Field field : fields) {  
                String type = field.getType().getName();  
                if (type.contains(List.class.getName())) {  
                    listCount++; // åˆ¤æ–­å­—æ®µæ˜¯å¦ä¸ºListç±»å‹  
  
                    // æ£€æŸ¥Listæ˜¯å¦æ˜¯æ¥å£ç±»å‹  
                    Class genericClass = getGenericClass(field);  
                    if (null != genericClass && genericClass.isInterface()) {  
                        listInterfaceCount++;  
                    }  
                }  
  
                // åˆ¤æ–­å­—æ®µæ˜¯å¦ä¸ºfinalä¿®é¥°çš„Listç±»å‹  
                if (type.contains(List.class.getName()) && Modifier.isFinal(field.getModifiers())) {  
                    finalListCount++;  
                }  
            }  
  
            // ç¬¦åˆOkHttpClientç‰¹å¾çš„æ¡ä»¶æ£€æŸ¥  
            if (listCount == 4 && finalListCount == 2 && listInterfaceCount == 2) {  
                // è·å–å¹¶ç¡®è®¤OkHttpClientçš„åŒ…ç»“æ„å’Œçˆ¶ç±»  
                Class OkHttpClientClazz = classes.getEnclosingClass();  
                if (Cloneable.class.isAssignableFrom(OkHttpClientClazz)) {  
                    OkCompat.Cls_OkHttpClient = OkHttpClientClazz.getName();  
  
                    if (null != classes && null != classes.getPackage()) {  
                        Compat_PackageName = classes.getPackage().getName();  
                    }  
  
                    Class builderClazz = classes;  
  
                    // æŸ¥æ‰¾å¹¶æ³¨å…¥æ‹¦æˆªå™¨  
                    find_interceptor(builderClazz);  
  
                    // æŸ¥æ‰¾OkHttpClientç›¸å…³ç±»  
                    findClientAbout(OkHttpClientClazz);  
  
                    findTag1 = true; // æ ‡è®°æ‰¾åˆ°ç›®æ ‡  
                }  
            }  
        }  
    } catch (Throwable th) {  
        // æ•è·æ‰€æœ‰å¼‚å¸¸ä»¥é˜²æ­¢ä¸­æ–­æµç¨‹ï¼Œä½†ä¸å¤„ç†  
    }  
}  
  
/**  
 * æŸ¥æ‰¾å¹¶æ³¨å…¥Interceptoræ‹¦æˆªå™¨åˆ°Builderç±»ä¸­ã€‚  
 * æ­¤æ–¹æ³•ä¼šæ‰«æBuilderç±»çš„å­—æ®µï¼Œæ‰¾åˆ°ç¬¦åˆæ‹¦æˆªå™¨çš„å­—æ®µå¹¶è¿›è¡Œé…ç½®ã€‚  
 *  
 * @param builderClazz éœ€è¦æŸ¥æ‰¾çš„Builderç±»  
 */  
private void find_interceptor(Class builderClazz) {  
    // æ£€æŸ¥åŒ…åæ˜¯å¦ç¬¦åˆæ¡ä»¶  
    if (!checkPackage(builderClazz)) return;  
  
    Field[] declaredFields = builderClazz.getDeclaredFields();  
    Field.setAccessible(declaredFields, true); // è®¾ç½®å­—æ®µè®¿é—®æƒé™  
    int index = 0; // ç”¨äºè®¡æ•°æ‰¾åˆ°çš„æ‹¦æˆªå™¨å­—æ®µ  
  
    for (Field field : declaredFields) {  
        // æ£€æŸ¥å­—æ®µæ˜¯å¦ä¸ºfinalä¿®é¥°çš„Listç±»å‹ä¸”åŒ…å«æ¥å£  
        if (List.class.isAssignableFrom(field.getType()) && Modifier.isFinal(field.getModifiers())  
                && getGenericClass(field).isInterface()) {  
            if (index == 0) {  
                // æ³¨å…¥è‡ªå®šä¹‰Interceptorï¼Œæä¾›ç»™JSè°ƒç”¨çš„å›è°ƒ  
                findInterceptor(field);  
                index++;  
            }  
        }  
    }  
}  
  
```  
[æ‹¦æˆªå™¨åŠ è½½å…³é”®ç‚¹](https://github.com/siyujie/OkHttpLogger-Frida/blob/c70da16d107c67d451d7112cfee7ee090589a527/okhttp_poker.js#L489)  
```java  
/**  
 * hookRealCall - æ‹¦æˆª OkHttp çš„ RealCall ç±»çš„ç½‘ç»œè¯·æ±‚ã€‚  
 * è¯¥æ–¹æ³•é€šè¿‡æ‹¦æˆª RealCall ç±»çš„ `enqueue`ï¼ˆå¼‚æ­¥è¯·æ±‚ï¼‰å’Œ `execute`ï¼ˆåŒæ­¥è¯·æ±‚ï¼‰æ–¹æ³•ï¼Œ  
 * å®ç°å¯¹ç½‘ç»œè¯·æ±‚å’Œå“åº”çš„æ•è·å’Œå¤„ç†ã€‚  
 *  
 * @param {string} realCallClassName - OkHttp RealCall ç±»çš„å®Œæ•´ç±»åã€‚  
 */  
function hookRealCall(realCallClassName) {  
    Java.perform(function () {  
        console.log(" ...........  hookRealCall  : " + realCallClassName)  
  
        // è·å– RealCall ç±»  
        var RealCall = Java.use(realCallClassName)  
  
        // æ£€æŸ¥æ˜¯å¦å®šä¹‰äº† Cls_CallBack ç±»ï¼ˆç”¨äºå¼‚æ­¥è¯·æ±‚æ‹¦æˆªï¼‰  
        if ("" != Cls_CallBack) {  
            // æ‹¦æˆª RealCall ç±»ä¸­çš„å¼‚æ­¥æ–¹æ³• enqueue  
            RealCall[M_Call_enqueue].overload(Cls_CallBack).implementation = function (callback) {  
                // è·å– callback çš„ç±»  
                var realCallBack = Java.use(callback.$className)  
  
                // æ‹¦æˆª callback ä¸­çš„ onResponse æ–¹æ³•ï¼Œä¿®æ”¹è¿”å›çš„å“åº”æ•°æ®  
                realCallBack[M_CallBack_onResponse].overload(Cls_Call, Cls_Response).implementation = function(call, response) {  
                    // ä½¿ç”¨è‡ªå®šä¹‰çš„ buildNewResponse æ–¹æ³•åˆ›å»ºæ–°çš„å“åº”æ•°æ®  
                    var newResponse = buildNewResponse(response)  
                    // ç»§ç»­æ‰§è¡ŒåŸå§‹çš„ onResponse æ–¹æ³•ï¼Œä¼ å…¥æ–°çš„å“åº”æ•°æ®  
                    this[M_CallBack_onResponse](call, newResponse)  
                }  
  
                // è°ƒç”¨åŸå§‹çš„ enqueue æ–¹æ³•ï¼Œä¼ å…¥ä¿®æ”¹åçš„ callback  
                this[M_Call_enqueue](callback)  
                // é‡Šæ”¾ callback ç±»å¼•ç”¨  
                realCallBack.$dispose  
            }  
        }  
  
        // æ‹¦æˆª RealCall ç±»ä¸­çš„åŒæ­¥æ–¹æ³• execute  
        RealCall[M_Call_execute].overload().implementation = function () {  
            // è°ƒç”¨åŸå§‹çš„ execute æ–¹æ³•ï¼Œè·å–å“åº”æ•°æ®  
            var response = this[M_Call_execute]()  
            // ä½¿ç”¨è‡ªå®šä¹‰çš„ buildNewResponse æ–¹æ³•åˆ›å»ºæ–°çš„å“åº”æ•°æ®  
            var newResponse = buildNewResponse(response)  
            // è¿”å›æ–°çš„å“åº”æ•°æ®  
            return newResponse;  
        }  
    })  
}  
  
```  
  
`ä½¿ç”¨æ“ä½œ:`  
1.å°†Â `okhttpfind.dex`Â æ‹·è´åˆ°Â `/data/local/tmp/`Â ç›®å½•ä¸‹ï¼ˆé¡ºå¸¦è®¾ç½®ä¸€ä¸‹777æƒé™ï¼‰  
2.æ‰§è¡Œå‘½ä»¤å¯åŠ¨`frida -U wuaipojie -l okhttp_poker.js`Â å¯è¿½åŠ Â `-o [output filepath]`ä¿å­˜åˆ°æ–‡ä»¶  
3.æ‰§è¡Œfind()å’Œhold()æ–¹æ³•çœ‹çœ‹æ•ˆæœ  
```  
D:\Program Files\WORKON_HOME\frida16\frida-agent-example>frida -U wuaipojie -l okhttp_poker.js  
     ____  
    / _  |   Frida 16.1.3 - A world-class dynamic instrumentation toolkit  
   | (_| |  
    > _  |   Commands:  
   /_/ |_|       help      -> Displays the help system  
   . . . .       object?   -> Display information about 'object'  
   . . . .       exit/quit -> Exit  
   . . . .  
   . . . .   More info at https://frida.re/docs/home/  
   . . . .  
   . . . .   Connected to Redmi K30 (id=30d9b4bf)  
Attaching...  
  
------------------------- OkHttp Poker by SingleMan [V.20201130]------------------------------------  
API:  
   >>>  find()                                         æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†Okhttp & æ˜¯å¦å¯èƒ½è¢«æ··æ·† & å¯»æ‰¾okhttp3å…³é”®ç±»åŠå‡½æ•°  
   >>>  switchLoader("okhttp3.OkHttpClient")           å‚æ•°ï¼šé™æ€åˆ†æåˆ°çš„okhttpclientç±»å  
   >>>  hold()                                         å¼€å¯HOOKæ‹¦æˆª  
   >>>  history()                                      æ‰“å°å¯é‡æ–°å‘é€çš„è¯·æ±‚  
   >>>  resend(index)                                  é‡æ–°å‘é€è¯·æ±‚  
----------------------------------------------------------------------------------------  
[Redmi K30::wuaipojie ]-> find()  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ æœª æ·· æ·† (ä»…å‚è€ƒ)~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
likelyClazzList size :352  
  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Start Find~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Find Result~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
var Cls_Call = "okhttp3.Call";  
var Cls_CallBack = "okhttp3.Callback";  
var Cls_OkHttpClient = "okhttp3.OkHttpClient";  
var M_rsp$builder_build = "build";  
var M_rsp_newBuilder = "newBuilder";  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~Find Complete~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
[Redmi K30::wuaipojie ]-> hold()  
[Redmi K30::wuaipojie ]->  ...........  hookRealCall  : okhttp3.RealCall  
  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
| URL: http://192.168.124.21:5000/get_user_data  
|  
| Method: GET  
|  
| Request Headers: 0  
|     no headers  
|  
|--> END  
|  
| URL: http://192.168.124.21:5000/get_user_data  
|  
| Status Code: 200 / OK  
|  
| Response Headers: 5  
|   â”Œâ”€Server: Werkzeug/2.3.3 Python/3.10.11  
|   â”Œâ”€Date: Sun, 27 Oct 2024 04:27:52 GMT  
|   â”Œâ”€Content-Type: application/json  
|   â”Œâ”€Content-Length: 104  
|   â””â”€Connection: close  
|  
| Response Body:  
|   {"user_data":"{\"user_id\": \"zj2595\", \"is_vip\": true, \"vip_level\": \"5\", \"coin_amount\": 115}"}  
  
|  
|<-- END HTTP  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
```  
## 2.åº•å±‚ç½‘ç»œè‡ªå&r0capture  
é—®é¢˜:å¦‚æœappä¸æ˜¯ç”¨okhttpå¼€å‘çš„å‘¢ï¼Ÿæˆ–è€…æ··æ·†å®šä½ä¸åˆ°ï¼Ÿ  
[[åŸåˆ›]androidæŠ“åŒ…å­¦ä¹ çš„æ•´ç†å’Œå½’çº³](https://bbs.kanxue.com/thread-267940.htm)  
[r0captureå¼€æºåœ°å€](https://github.com/r0ysue/r0capture)  
### 1.java å±‚ http å‘åŒ…  
  
```mermaid  
%%{init: {  
  'theme': 'base',  
  'themeVariables': {  
    'fontSize': '16px',  
    'fontFamily': 'arial',  
    'lineColor': '#ff8c00',  
    'primaryColor': '#ffe4b5',  
    'primaryTextColor': '#333',  
    'primaryBorderColor': '#ff8c00',  
    'secondaryColor': '#e6f7ff',  
    'tertiaryColor': '#fff'  
  }  
}}%%  
  
graph TD  
    %% ä¸»èŠ‚ç‚¹æ ·å¼å®šä¹‰  
    classDef mainNode fill:#ffe4b5,stroke:#ff8c00,stroke-width:3px,color:#333,padding:15px;  
    classDef noteNode fill:#e6f7ff,stroke:#1e90ff,stroke-width:2px,color:#1e90ff,padding:10px;  
  
    %% ä¸»è¦èŠ‚ç‚¹  
    A[/"OutputStream.write<br><small>å‘é€å­—èŠ‚æ•°ç»„</small>"/]:::mainNode  
    B[/"SocketOutputStream.socketWrite<br><small>æ¥æ”¶æ•°ç»„ã€åç§»å’Œé•¿åº¦</small>"/]:::mainNode  
    C[/"SocketOutputStream.socketWrite0<br><small>æ‰§è¡Œæ•°æ®å‘é€</small>"/]:::mainNode  
  
    %% æ³¨é‡ŠèŠ‚ç‚¹  
    noteA["ğŸ” OutputStream.write<br><small>è°ƒç”¨è€…é€šè¿‡è¿™ä¸ªæ–¹æ³•å‘é€å­—èŠ‚æ•°ç»„</small>"]:::noteNode  
    noteB["ğŸ“ SocketOutputStream.socketWrite<br><small>ç¡®ä¿æ•°æ®æœ‰æ•ˆæ€§ï¼Œä¼ é€’åç§»é‡å’Œé•¿åº¦</small>"]:::noteNode  
    noteC["âš¡ SocketOutputStream.socketWrite0<br><small>nativeæ–¹æ³•ï¼Œè´Ÿè´£å®é™…æ•°æ®å‘é€</small>"]:::noteNode  
  
    %% è¿æ¥å…³ç³»  
    A --> |"è°ƒç”¨"| B  
    B --> |"è°ƒç”¨"| C  
  
    %% è™šçº¿è¿æ¥æ³¨é‡Š  
    A -.-o noteA  
    B -.-o noteB  
    C -.-o noteC  
  
    %% å¸ƒå±€è°ƒæ•´  
    linkStyle 0,1 stroke:#ff8c00,stroke-width:2px;  
    linkStyle 2,3,4 stroke:#1e90ff,stroke-width:1px,stroke-dasharray:5 5;  
```  
  
```mermaid  
%%{init: {  
  'theme': 'base',  
  'themeVariables': {  
    'fontSize': '16px',  
    'fontFamily': 'arial',  
    'lineColor': '#ff8c00',  
    'primaryColor': '#ffe4b5',  
    'primaryTextColor': '#333',  
    'primaryBorderColor': '#ff8c00',  
    'secondaryColor': '#e6f7ff',  
    'tertiaryColor': '#fff'  
  }  
}}%%  
  
graph TD  
    %% ä¸»èŠ‚ç‚¹æ ·å¼å®šä¹‰  
    classDef mainNode fill:#ffe4b5,stroke:#ff8c00,stroke-width:3px,color:#333,padding:15px;  
    classDef noteNode fill:#e6f7ff,stroke:#1e90ff,stroke-width:2px,color:#1e90ff,padding:10px;  
  
    %% ä¸»è¦èŠ‚ç‚¹  
    A[/"BufferedReader.readLine<br><small>ä»æµä¸­è¯»å–ç›´åˆ°æ¢è¡Œç¬¦</small>"/]:::mainNode  
    B[/"InputStreamReader.read<br><small>è¯»å–æ•°æ®åˆ°å­—ç¬¦ç¼“å†²åŒº</small>"/]:::mainNode  
    C[/"SocketInputStream.read<br><small>ä»Socketä¸­è¯»å–å­—èŠ‚æ•°æ®</small>"/]:::mainNode  
    D[/"socketRead<br><small>è®¾ç½®è¶…æ—¶å¹¶è°ƒç”¨nativeæ–¹æ³•</small>"/]:::mainNode  
    E[/"socketRead0<br><small>æœ¬åœ°ä»£ç æ¡¥æ¢</small>"/]:::mainNode  
  
    %% æ³¨é‡ŠèŠ‚ç‚¹  
    noteA["ğŸ“˜ BufferedReader.readLine<br><small>Javaå±‚çš„å…¥å£æ–¹æ³•</small>"]:::noteNode  
    noteB["ğŸ§© InputStreamReader.read<br><small>ä»åº•å±‚è¾“å…¥æµä¸­è¯»å–æ•°æ®</small>"]:::noteNode  
    noteC["ğŸ§© SocketInputStream.read<br><small>ä»Socketè¿æ¥è¯»å–å­—èŠ‚æ•°æ®</small>"]:::noteNode  
    noteD["ğŸ› ï¸ socketRead<br><small>è¾…åŠ©æ–¹æ³•ï¼Œè®¾ç½®è¶…æ—¶</small>"]:::noteNode  
    noteE["ğŸ› ï¸ socketRead0<br><small>nativeæ–¹æ³•ï¼Œæ‰§è¡Œå®é™…è¯»å–</small>"]:::noteNode  
  
    %% è¿æ¥å…³ç³»  
    A --> |"è°ƒç”¨"| B  
    B --> |"è°ƒç”¨"| C  
    C --> |"è°ƒç”¨"| D  
    D --> |"è°ƒç”¨"| E  
  
    %% è™šçº¿è¿æ¥æ³¨é‡Š  
    A -.-o noteA  
    B -.-o noteB  
    C -.-o noteC  
    D -.-o noteD  
    E -.-o noteE  
  
    %% å¸ƒå±€è°ƒæ•´  
    linkStyle 0,1,2,3 stroke:#ff8c00,stroke-width:2px;  
    linkStyle 4,5,6,7,8 stroke:#1e90ff,stroke-width:1px,stroke-dasharray:5 5;  
  
```  
  
`Hookå®ç°`  
```js  
// ä½¿ç”¨ Java.use æ–¹æ³•è·å– java.net.SocketOutputStream ç±»ï¼Œå¹¶é‡å†™ socketWrite0 æ–¹æ³•  
Java.use("java.net.SocketOutputStream").socketWrite0.overload('java.io.FileDescriptor', '[B', 'int', 'int').implementation = function (fd, bytearry, offset, byteCount) {  
    // è°ƒç”¨åŸå§‹çš„ socketWrite0 æ–¹æ³•  
    var result = this.socketWrite0(fd, bytearry, offset, byteCount);  
  
    // åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡ç”¨äºå­˜å‚¨æ•°æ®  
    var message = {};  
    message["function"] = "HTTP_send"; // æ ‡è¯†ä¸º HTTP å‘é€æ“ä½œ  
    message["ssl_session_id"] = ""; // SSL ä¼šè¯ ID ä¸ºç©º  
  
    // è·å–æœ¬åœ°åœ°å€å’Œç«¯å£  
    message["src_addr"] = ntohl(ipToNumber((this.socket.value.getLocalAddress().toString().split(":")[0]).split("/").pop()));  
    message["src_port"] = parseInt(this.socket.value.getLocalPort().toString());  
  
    // è·å–è¿œç¨‹åœ°å€å’Œç«¯å£  
    message["dst_addr"] = ntohl(ipToNumber((this.socket.value.getRemoteSocketAddress().toString().split(":")[0]).split("/").pop()));  
    message["dst_port"] = parseInt(this.socket.value.getRemoteSocketAddress().toString().split(":").pop());  
  
    // è·å–è°ƒç”¨æ ˆä¿¡æ¯  
    message["stack"] = Java.use("android.util.Log").getStackTraceString(Java.use("java.lang.Throwable").$new()).toString();  
  
    // å°†è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°å†…å­˜ä¸­  
    var ptr = Memory.alloc(byteCount);  
    for (var i = 0; i < byteCount; ++i)  
        Memory.writeS8(ptr.add(i), bytearry[offset + i]);  
  
    // å‘é€æ¶ˆæ¯å’Œæ•°æ®  
    send(message, Memory.readByteArray(ptr, byteCount));  
  
    // è¿”å›åŸå§‹æ–¹æ³•çš„ç»“æœ  
    return result;  
}  
  
// ä½¿ç”¨ Java.use æ–¹æ³•è·å– java.net.SocketInputStream ç±»ï¼Œå¹¶é‡å†™ socketRead0 æ–¹æ³•  
Java.use("java.net.SocketInputStream").socketRead0.overload('java.io.FileDescriptor', '[B', 'int', 'int', 'int').implementation = function (fd, bytearry, offset, byteCount, timeout) {  
    // è°ƒç”¨åŸå§‹çš„ socketRead0 æ–¹æ³•  
    var result = this.socketRead0(fd, bytearry, offset, byteCount, timeout);  
  
    // åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡ç”¨äºå­˜å‚¨æ•°æ®  
    var message = {};  
    message["function"] = "HTTP_recv"; // æ ‡è¯†ä¸º HTTP æ¥æ”¶æ“ä½œ  
    message["ssl_session_id"] = ""; // SSL ä¼šè¯ ID ä¸ºç©º  
  
    // è·å–è¿œç¨‹åœ°å€å’Œç«¯å£ï¼ˆä½œä¸ºæºåœ°å€ï¼‰  
    message["src_addr"] = ntohl(ipToNumber((this.socket.value.getRemoteSocketAddress().toString().split(":")[0]).split("/").pop()));  
    message["src_port"] = parseInt(this.socket.value.getRemoteSocketAddress().toString().split(":").pop());  
  
    // è·å–æœ¬åœ°åœ°å€å’Œç«¯å£ï¼ˆä½œä¸ºç›®æ ‡åœ°å€ï¼‰  
    message["dst_addr"] = ntohl(ipToNumber((this.socket.value.getLocalAddress().toString().split(":")[0]).split("/").pop()));  
    message["dst_port"] = parseInt(this.socket.value.getLocalPort());  
  
    // è·å–è°ƒç”¨æ ˆä¿¡æ¯  
    message["stack"] = Java.use("android.util.Log").getStackTraceString(Java.use("java.lang.Throwable").$new()).toString();  
  
    // å¦‚æœè¯»å–åˆ°çš„æ•°æ®å­—èŠ‚æ•°å¤§äº 0ï¼Œå°†æ•°æ®æ‹·è´åˆ°å†…å­˜å¹¶å‘é€  
    if (result > 0) {  
        var ptr = Memory.alloc(result);  
        for (var i = 0; i < result; ++i)  
            Memory.writeS8(ptr.add(i), bytearry[offset + i]);  
        send(message, Memory.readByteArray(ptr, result));  
    }  
  
    // è¿”å›åŸå§‹æ–¹æ³•çš„ç»“æœ  
    return result;  
}  
  
  
```  
é€šè¿‡æ‹¦æˆª Java ä¸­çš„ `socketWrite0` å’Œ `socketRead0` æ–¹æ³•ï¼Œåœ¨æ•°æ®å‘é€å’Œæ¥æ”¶æ—¶æ”¶é›†ç›¸å…³ä¿¡æ¯å¹¶å‘é€ç»™æŒ‡å®šçš„æ¥æ”¶æ–¹ï¼Œä»¥ä¾¿è¿›è¡Œç›‘æ§æˆ–è°ƒè¯•  
  
### 2.java å±‚ https å‘åŒ…  
```mermaid  
%%{init: {  
  'theme': 'base',  
  'themeVariables': {  
    'fontSize': '16px',  
    'fontFamily': 'arial',  
    'lineColor': '#ff9933',  
    'primaryColor': '#ffebcc',  
    'primaryTextColor': '#333',  
    'primaryBorderColor': '#ff9933',  
    'secondaryColor': '#d9eaf7',  
    'tertiaryColor': '#fff'  
  }  
}}%%  
  
graph TD  
    %% ä¸»èŠ‚ç‚¹æ ·å¼å®šä¹‰  
    classDef mainNode fill:#ffebcc,stroke:#ff9933,stroke-width:2px,color:#333,padding:10px;  
    classDef noteNode fill:#d9eaf7,stroke:#337ab7,stroke-width:2px,color:#1e90ff,padding:10px;  
  
    %% ä¸»è¦èŠ‚ç‚¹  
    A[/"SSLOutputStream<br><small>write()</small>"/]:::mainNode  
    B[/"NativeCrypto<br><small>SSL_write()</small>"/]:::mainNode  
    C[/"SSLInputStream<br><small>read()</small>"/]:::mainNode  
    D[/"NativeCrypto<br><small>SSL_read()</small>"/]:::mainNode  
  
    %% æ³¨é‡ŠèŠ‚ç‚¹  
    noteA["ğŸ“ SSLOutputStream.write<br><small>ç”¨äºå†™å…¥éœ€è¦åŠ å¯†çš„æ•°æ®</small>"]:::noteNode  
    noteB["ğŸ› ï¸ NativeCrypto.SSL_write<br><small>nativeæ–¹æ³•ï¼Œå®é™…çš„åŠ å¯†æ•°æ®å†™å…¥æ“ä½œ</small>"]:::noteNode  
    noteC["ğŸ“ SSLInputStream.read<br><small>ç”¨äºä»SSLä¼šè¯ä¸­è¯»å–åŠ å¯†æ•°æ®</small>"]:::noteNode  
    noteD["ğŸ› ï¸ NativeCrypto.SSL_read<br><small>nativeæ–¹æ³•ï¼Œå®é™…çš„è§£å¯†æ•°æ®è¯»å–æ“ä½œ</small>"]:::noteNode  
  
    %% è¿æ¥å…³ç³»  
    A --> |"è°ƒç”¨"| B  
    C --> |"è°ƒç”¨"| D  
    B <--> |"hookç‚¹"| D  
  
    %% è™šçº¿è¿æ¥æ³¨é‡Š  
    A -.-o noteA  
    B -.-o noteB  
    C -.-o noteC  
    D -.-o noteD  
  
    %% å¸ƒå±€è°ƒæ•´  
    linkStyle 0,1 stroke:#ff9933,stroke-width:2px;  
    linkStyle 2 stroke:#ff9933,stroke-width:1.5px,stroke-dasharray:4 4;  
    linkStyle 3,4,5,6 stroke:#999999,stroke-width:1px,stroke-dasharray:5 5;  
  
```  
  
`Hookå®ç°`  
```js  
// æ‹¦æˆª SSLOutputStream ç±»çš„ write æ–¹æ³•  
Java.use("com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream").write.overload('[B', 'int', 'int').implementation = function (bytearry, int1, int2) {  
    // è°ƒç”¨åŸå§‹çš„ write æ–¹æ³•  
    var result = this.write(bytearry, int1, int2);  
    // è·å–å½“å‰è°ƒç”¨æ ˆçš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå­˜å‚¨ SSL æ•°æ®å†™å…¥æ—¶çš„è°ƒç”¨æ ˆ  
    SSLstackwrite = Java.use("android.util.Log").getStackTraceString(Java.use("java.lang.Throwable").$new()).toString();  
    // è¿”å›åŸå§‹æ–¹æ³•çš„ç»“æœ  
    return result;  
}  
  
// æ‹¦æˆª SSLInputStream ç±»çš„ read æ–¹æ³•  
Java.use("com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream").read.overload('[B', 'int', 'int').implementation = function (bytearry, int1, int2) {  
    // è°ƒç”¨åŸå§‹çš„ read æ–¹æ³•  
    var result = this.read(bytearry, int1, int2);  
    // è·å–å½“å‰è°ƒç”¨æ ˆçš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå­˜å‚¨ SSL æ•°æ®è¯»å–æ—¶çš„è°ƒç”¨æ ˆ  
    SSLstackread = Java.use("android.util.Log").getStackTraceString(Java.use("java.lang.Throwable").$new()).toString();  
    // è¿”å›åŸå§‹æ–¹æ³•çš„ç»“æœ  
    return result;  
}  
  
```  
æ‹¦æˆªäº† `SSLOutputStream` å’Œ `SSLInputStream` ç±»çš„ `write` å’Œ `read` æ–¹æ³•ï¼Œåœ¨è¿›è¡Œæ•°æ®è¯»å†™æ—¶è·å–å½“å‰çš„è°ƒç”¨æ ˆä¿¡æ¯  
  
### 3.native å±‚ http å‘åŒ…  
```mermaid  
%%{init: {  
  'theme': 'base',  
  'themeVariables': {  
    'fontSize': '16px',  
    'fontFamily': 'arial',  
    'lineColor': '#ff9933',  
    'primaryColor': '#ffebcc',  
    'primaryTextColor': '#333',  
    'primaryBorderColor': '#ff9933',  
    'secondaryColor': '#d9eaf7',  
    'tertiaryColor': '#fff'  
  }  
}}%%  
  
graph TD  
    %% ä¸»èŠ‚ç‚¹æ ·å¼å®šä¹‰  
    classDef mainNode fill:#ffebcc,stroke:#ff9933,stroke-width:2px,color:#333,padding:10px;  
    classDef noteNode fill:#d9eaf7,stroke:#337ab7,stroke-width:2px,color:#1e90ff,padding:10px;  
  
    %% ä¸»è¦èŠ‚ç‚¹  
    A[/"native<br><small>socketWrite0</small>"/]:::mainNode  
    B[/"libopenjdk.so<br><small>NET_Send</small>"/]:::mainNode  
    C[/"libc.so<br><small>sendto</small>"/]:::mainNode  
    D[/"native<br><small>socketRead0</small>"/]:::mainNode  
    E[/"libopenjdk.so<br><small>NET_Read</small>"/]:::mainNode  
    F[/"libc.so<br><small>recvfrom</small>"/]:::mainNode  
  
    %% è¿æ¥å…³ç³»  
    A -->|"è°ƒç”¨"| B  
    B -->|"è°ƒç”¨"| C  
    D -->|"è°ƒç”¨"| E  
    E -->|"è°ƒç”¨"| F  
    C <--> |"hookç‚¹"| F  
  
    %% å¸ƒå±€è°ƒæ•´  
    linkStyle 0,1,2,3 stroke:#ff9933,stroke-width:2px;  
    linkStyle 4 stroke:#ff9933,stroke-width:1.5px,stroke-dasharray:4 4;  
  
    %% å¸ƒå±€æç¤º - ä½¿ç”¨subgraphå¯¹èŠ‚ç‚¹åˆ†ç»„  
    subgraph "Writeè°ƒç”¨é“¾"  
        direction TB  
        A --> B --> C  
    end  
  
    subgraph "Readè°ƒç”¨é“¾"  
        direction TB  
        D --> E --> F  
    end  
```  
  
| å‡½æ•°åç§°                   | æè¿°                                                    |  
| ---------------------- | ----------------------------------------------------- |  
| native.socketWrite0    | è¿™æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œè´Ÿè´£ä» Java å±‚å‘åº•å±‚ç½‘ç»œæ¥å£å†™å…¥æ•°æ®ã€‚                 |  
| libopenjdk.so.NET_Send | è¿™æ˜¯ `libopenjdk.so` ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨åº•å±‚çš„ `sendto` æ–¹æ³•ï¼Œç”¨äºå‘é€æ•°æ®ã€‚   |  
| libc.so.sendto         | è¿™æ˜¯ä¸€ä¸ªåº•å±‚ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå°†æ•°æ®å‘é€åˆ°æŒ‡å®šçš„ç½‘ç»œåœ°å€ã€‚                           |  
| native.socketRead0     | è¿™æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œç”¨äºä»åº•å±‚ç½‘ç»œæ¥å£è¯»å–æ•°æ®ã€‚                         |  
| libopenjdk.so.NET_Read | è¿™æ˜¯ `libopenjdk.so` ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨åº•å±‚çš„ `recvfrom` æ–¹æ³•ï¼Œè´Ÿè´£æ¥æ”¶æ•°æ®ã€‚ |  
| libopenjdk.so.recvfrom | è¿™æ˜¯ä¸€ä¸ªåº•å±‚ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œç”¨äºä»ç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…ã€‚                            |  
`Hookå®ç°`  
```js  
// è·å– libc.so åº“ä¸­çš„ sendto å’Œ recvfrom å‡½æ•°çš„æŒ‡é’ˆ  
var sendtoPtr = Module.getExportByName("libc.so", "sendto");  
var recvfromPtr = Module.getExportByName("libc.so", "recvfrom");  
console.log("sendto:", sendtoPtr, ", recvfrom:", recvfromPtr);  
  
// æ‹¦æˆª sendto å‡½æ•°  
// sendto(int fd, const void *buf, size_t n, int flags, const struct sockaddr *addr, socklen_t addr_len)  
Interceptor.attach(sendtoPtr, {  
    onEnter: function(args) {  
        // è·å–æ–‡ä»¶æè¿°ç¬¦ fd  
        var fd = args[0];  
        // è·å–è¦å‘é€çš„ç¼“å†²åŒºæŒ‡é’ˆ buff  
        var buff = args[1];  
        // è·å–æ•°æ®å¤§å° size  
        var size = args[2];  
  
        // è·å–å¥—æ¥å­—çš„ç›¸å…³ä¿¡æ¯  
        var sockdata = getSocketData(fd.toInt32());  
        console.log(sockdata);  
  
        // æ‰“å°ç¼“å†²åŒºçš„åå…­è¿›åˆ¶å†…å®¹  
        console.log(hexdump(buff, { length: size.toInt32() }));  
    },  
    onLeave: function(retval) {  
        // ç¦»å¼€ sendto å‡½æ•°æ—¶ä¸åšé¢å¤–å¤„ç†  
    }  
});  
  
// æ‹¦æˆª recvfrom å‡½æ•°  
// recvfrom(int fd, void *buf, size_t n, int flags, struct sockaddr *addr, socklen_t *addr_len)  
Interceptor.attach(recvfromPtr, {  
    onEnter: function(args) {  
        // è·å–æ–‡ä»¶æè¿°ç¬¦ fd  
        this.fd = args[0];  
        // è·å–ç¼“å†²åŒºæŒ‡é’ˆ buff  
        this.buff = args[1];  
        // è·å–æ•°æ®å¤§å° size  
        this.size = args[2];  
    },  
    onLeave: function(retval) {  
        // è·å–å¥—æ¥å­—çš„ç›¸å…³ä¿¡æ¯  
        var sockdata = getSocketData(this.fd.toInt32());  
        console.log(sockdata);  
  
        // æ‰“å°æ¥æ”¶åˆ°çš„ç¼“å†²åŒºçš„åå…­è¿›åˆ¶å†…å®¹  
        console.log(hexdump(this.buff, { length: this.size.toInt32() }));  
    }  
});  
  
  
```  
æ‹¦æˆª `sendto` å’Œ `recvfrom` å‡½æ•°ï¼Œæ•è·å‘é€å’Œæ¥æ”¶çš„æ•°æ®åŒ…ã€‚`onEnter` é’©å­å‡½æ•°ç”¨äºåœ¨å‡½æ•°è°ƒç”¨å‰å¤„ç†å‚æ•°ï¼Œè·å–æ–‡ä»¶æè¿°ç¬¦å’Œç¼“å†²åŒºåœ°å€ï¼Œè°ƒç”¨ `hexdump` æ‰“å°ç¼“å†²åŒºå†…å®¹ä»¥ä¾¿æŸ¥çœ‹å®é™…å‘é€æˆ–æ¥æ”¶çš„æ•°æ®  
### 4.native å±‚ https å‘åŒ…  
```mermaid  
%%{init: {  
  'theme': 'base',  
  'themeVariables': {  
    'fontSize': '16px',  
    'fontFamily': 'arial',  
    'lineColor': '#ff9933',  
    'primaryColor': '#ffebcc',  
    'primaryTextColor': '#333',  
    'primaryBorderColor': '#ff9933',  
    'secondaryColor': '#d9eaf7',  
    'tertiaryColor': '#fff'  
  }  
}}%%  
  
graph TD  
    %% ä¸»èŠ‚ç‚¹æ ·å¼å®šä¹‰  
    classDef mainNode fill:#ffebcc,stroke:#ff9933,stroke-width:2px,color:#333,padding:10px;  
    classDef noteNode fill:#d9eaf7,stroke:#337ab7,stroke-width:2px,color:#1e90ff,padding:10px;  
  
    %% å†™è°ƒç”¨é“¾èŠ‚ç‚¹  
    W1[/"native<br><small>NativeCrypto_SSL_write</small>"/]:::mainNode  
    W2[/"libboringssl.so<br><small>SSL_write</small>"/]:::mainNode  
    W3[/"libc.so<br><small>write</small>"/]:::mainNode  
  
    %% å†™è°ƒç”¨é“¾æ³¨é‡Š  
    noteW1["ğŸ“„ NativeCrypto_SSL_write<br><small>ä¼ å…¥æ˜æ–‡</small>"]:::noteNode  
    noteW2["ğŸ”’ SSL_write<br><small>åŠ å¯†å¤„ç†ï¼Œå¯ hook æ˜æ–‡æ•°æ®</small>"]:::noteNode  
    noteW3["ğŸ“¤ write<br><small>å†™å…¥åŠ å¯†æ•°æ®ï¼ˆå¯†æ–‡ï¼‰ï¼Œå¯ hook å¯†æ–‡</small>"]:::noteNode  
  
    %% è¯»è°ƒç”¨é“¾èŠ‚ç‚¹  
    R1[/"libc.so<br><small>read</small>"/]:::mainNode  
    R2[/"libopenjdk.so<br><small>SSL_read</small>"/]:::mainNode  
    R3[/"native<br><small>NativeCrypto_SSL_read</small>"/]:::mainNode  
  
    %% è¯»è°ƒç”¨é“¾æ³¨é‡Š  
    noteR1["ğŸ“¥ read<br><small>è¯»å–å¯†æ–‡æ•°æ®ï¼Œå¯ hook è·å–å¯†æ–‡</small>"]:::noteNode  
    noteR2["ğŸ”“ SSL_read<br><small>è§£å¯†å¤„ç†ï¼Œå¯ hook æ˜æ–‡æ•°æ®</small>"]:::noteNode  
    noteR3["ğŸ“„ NativeCrypto_SSL_read<br><small>è¿”å›æ˜æ–‡æ•°æ®ç»™ä¸Šå±‚åº”ç”¨</small>"]:::noteNode  
  
    %% å†™è°ƒç”¨é“¾è¿æ¥å…³ç³»  
    W1 --> |"è°ƒç”¨"| W2 --> |"è°ƒç”¨"| W3  
    W1 -.-o noteW1  
    W2 -.-o noteW2  
    W3 -.-o noteW3  
  
    %% è¯»è°ƒç”¨é“¾è¿æ¥å…³ç³»  
    R1 --> |"è°ƒç”¨"| R2 --> |"è°ƒç”¨"| R3  
    R1 -.-o noteR1  
    R2 -.-o noteR2  
    R3 -.-o noteR3  
  
    %% å¸ƒå±€è°ƒæ•´ - å‚ç›´æ’åˆ—  
    subgraph "å†™è°ƒç”¨é“¾"  
        direction TB  
        W1 --> W2 --> W3  
    end  
  
    subgraph "è¯»è°ƒç”¨é“¾"  
        direction TB  
        R1 --> R2 --> R3  
    end  
  
```  
  
`Hookå®ç°`  
```js  
// è·å– libc.so åº“ä¸­çš„ write å’Œ read å‡½æ•°çš„æŒ‡é’ˆ  
var writePtr = Module.getExportByName("libc.so", "write");  
var readPtr = Module.getExportByName("libc.so", "read");  
console.log("write:", writePtr, ", read:", readPtr);  
  
// æ‹¦æˆª write å‡½æ•°  
// write(int fd, const void *buf, size_t count)  
Interceptor.attach(writePtr, {  
    onEnter: function(args) {  
        // è·å–æ–‡ä»¶æè¿°ç¬¦ fd  
        var fd = args[0];  
        // è·å–å†™å…¥çš„æ•°æ®ç¼“å†²åŒºæŒ‡é’ˆ buff  
        var buff = args[1];  
        // è·å–æ•°æ®å¤§å° size  
        var size = args[2];  
  
        // è·å–å¥—æ¥å­—ä¿¡æ¯ï¼ˆå‡è®¾ getSocketData æ˜¯è‡ªå®šä¹‰å‡½æ•°ï¼‰  
        var sockdata = getSocketData(fd.toInt32());  
  
        // å¦‚æœå¥—æ¥å­—æ˜¯ TCP ç±»å‹ï¼Œæ‰“å°ç›¸å…³æ•°æ®  
        if (sockdata.indexOf("tcp") !== -1) {  
            console.log(sockdata);  
            console.log(hexdump(buff, { length: size.toInt32() }));  
        }  
    },  
    onLeave: function(retval) {  
        // ç¦»å¼€ write å‡½æ•°æ—¶ä¸åšé¢å¤–å¤„ç†  
    }  
});  
  
// æ‹¦æˆª read å‡½æ•°  
// read(int fd, void *buf, size_t count)  
Interceptor.attach(readPtr, {  
    onEnter: function(args) {  
        // è·å–æ–‡ä»¶æè¿°ç¬¦ fd  
        this.fd = args[0];  
        // è·å–è¯»å–çš„ç¼“å†²åŒºæŒ‡é’ˆ buff  
        this.buff = args[1];  
        // è·å–æ•°æ®å¤§å° size  
        this.size = args[2];  
    },  
    onLeave: function(retval) {  
        // è·å–å¥—æ¥å­—ä¿¡æ¯  
        var sockdata = getSocketData(this.fd.toInt32());  
  
        // å¦‚æœå¥—æ¥å­—æ˜¯ TCP ç±»å‹ï¼Œæ‰“å°ç›¸å…³æ•°æ®  
        if (sockdata.indexOf("tcp") !== -1) {  
            console.log(sockdata);  
            console.log(hexdump(this.buff, { length: this.size.toInt32() }));  
        }  
    }  
});  
  
// è·å– libssl.so ä¸­çš„ SSL_writeã€SSL_read å’Œ SSL_get_rfd å‡½æ•°çš„æŒ‡é’ˆ  
var sslWritePtr = Module.getExportByName("libssl.so", "SSL_write");  
var sslReadPtr = Module.getExportByName("libssl.so", "SSL_read");  
console.log("sslWrite:", sslWritePtr, ", sslRead:", sslReadPtr);  
  
// è·å– SSL_get_rfd å‡½æ•°çš„æŒ‡é’ˆï¼Œç”¨äºä» SSL ç»“æ„ä½“ä¸­è·å–æ–‡ä»¶æè¿°ç¬¦  
var sslGetFdPtr = Module.getExportByName("libssl.so", "SSL_get_rfd");  
// ä½¿ç”¨ NativeFunction åˆ›å»ºå¯¹ SSL_get_rfd å‡½æ•°çš„è°ƒç”¨  
var sslGetFdFunc = new NativeFunction(sslGetFdPtr, 'int', ['pointer']);  
  
// æ‹¦æˆª SSL_write å‡½æ•°  
// int SSL_write(SSL *ssl, const void *buf, int num)  
Interceptor.attach(sslWritePtr, {  
    onEnter: function(args) {  
        // è·å– SSL å¯¹è±¡æŒ‡é’ˆ  
        var sslPtr = args[0];  
        // è·å–è¦å‘é€çš„ç¼“å†²åŒºæŒ‡é’ˆ  
        var buff = args[1];  
        // è·å–æ•°æ®å¤§å°  
        var size = args[2];  
  
        // ä½¿ç”¨ SSL_get_rfd è·å–æ–‡ä»¶æè¿°ç¬¦  
        var fd = sslGetFdFunc(sslPtr);  
        // è·å–å¥—æ¥å­—çš„æ•°æ®ï¼ˆå‡è®¾ getSocketData æ˜¯è‡ªå®šä¹‰å‡½æ•°ï¼‰  
        var sockdata = getSocketData(fd);  
  
        // æ‰“å°å¥—æ¥å­—æ•°æ®å’Œå‘é€æ•°æ®çš„åå…­è¿›åˆ¶å†…å®¹  
        console.log(sockdata);  
        console.log(hexdump(buff, { length: size.toInt32() }));  
    },  
    onLeave: function(retval) {  
        // ç¦»å¼€ SSL_write å‡½æ•°æ—¶ä¸åšé¢å¤–å¤„ç†  
    }  
});  
  
// æ‹¦æˆª SSL_read å‡½æ•°  
// int SSL_read(SSL *ssl, void *buf, int num)  
Interceptor.attach(sslReadPtr, {  
    onEnter: function(args) {  
        // è·å– SSL å¯¹è±¡æŒ‡é’ˆ  
        this.sslPtr = args[0];  
        // è·å–æ¥æ”¶ç¼“å†²åŒºæŒ‡é’ˆ  
        this.buff = args[1];  
        // è·å–æ¥æ”¶æ•°æ®çš„å¤§å°  
        this.size = args[2];  
    },  
    onLeave: function(retval) {  
        // ä½¿ç”¨ SSL_get_rfd è·å–æ–‡ä»¶æè¿°ç¬¦  
        var fd = sslGetFdFunc(this.sslPtr);  
        // è·å–å¥—æ¥å­—çš„æ•°æ®  
        var sockdata = getSocketData(fd);  
  
        // æ‰“å°å¥—æ¥å­—æ•°æ®å’Œæ¥æ”¶åˆ°çš„åå…­è¿›åˆ¶æ•°æ®  
        console.log(sockdata);  
        console.log(hexdump(this.buff, { length: this.size.toInt32() }));  
    }  
});  
  
```  
`r0captureç®€ä»‹`  
- ä»…é™å®‰å“å¹³å°ï¼Œæµ‹è¯•å®‰å“7-14 å¯ç”¨ ï¼›  
- æ— è§†æ‰€æœ‰è¯ä¹¦æ ¡éªŒæˆ–ç»‘å®šï¼›  
- é€šæ€TCP/IPå››å±‚æ¨¡å‹ä¸­çš„åº”ç”¨å±‚ä¸­çš„å…¨éƒ¨åè®®ï¼›  
- é€šæ€åè®®åŒ…æ‹¬ï¼šHttp,WebSocket,Ftp,Xmpp,Imap,Smtp,Protobufç­‰ç­‰ã€ä»¥åŠå®ƒä»¬çš„SSLç‰ˆæœ¬ï¼›  
- é€šæ€æ‰€æœ‰åº”ç”¨å±‚æ¡†æ¶ï¼ŒåŒ…æ‹¬HttpUrlConnectionã€Okhttp1/3/4ã€Retrofit/Volleyç­‰ç­‰ï¼›  
- æ— è§†åŠ å›º  
å±€é™ï¼šéƒ¨åˆ†å¼€å‘å®åŠ›è¿‡å¼ºçš„å¤§å‚æˆ–æ¡†æ¶ï¼Œé‡‡ç”¨çš„æ˜¯è‡ªèº«çš„SSLæ¡†æ¶ï¼Œæ¯”å¦‚WebViewã€éƒ¨åˆ†èåˆAppã€å°ç¨‹åºæˆ–Flutterï¼Œè¿™éƒ¨åˆ†ç›®å‰æš‚æœªæ”¯æŒã€‚  
```  
python3 r0capture.py -U wuaipojie -v -p test.pcap  
```  
[wiresharkä¸‹è½½åœ°å€](https://www.wireshark.org/download.html)  
## 3.ebpfæŠ“åŒ…å®æˆ˜&ecapture  
### 1.ä»€ä¹ˆæ˜¯ebpf  
[what-is-ebpf](https://ebpf.io/what-is-ebpf/)  
eBPFæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Linux å†…æ ¸é‡Œé¢çš„è™šæ‹Ÿæœºç»„ä»¶ï¼Œå®ƒå¯ä»¥åœ¨æ— éœ€æ”¹å˜å†…æ ¸ä»£ç æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—çš„æƒ…å†µä¸‹ï¼Œå®‰å…¨è€Œåˆé«˜æ•ˆåœ°æ‹“å±•å†…æ ¸çš„åŠŸèƒ½ã€‚  
![å›¾ç‰‡](_assets_24/a79c8f5b13843a9791737f663c5354e07037.png)  
  
### 2.ebpfçš„åŠŸèƒ½ä¹‹ç½‘ç»œæŠ“åŒ…  
  
| åŠŸèƒ½         | æè¿°                                                         | ä¼˜åŠ¿                                               |  
| ---------- | ---------------------------------------------------------- | ------------------------------------------------ |  
| **ç³»ç»Ÿè°ƒç”¨ç›‘æ§** | ä½¿ç”¨ eBPF è„šæœ¬ç›‘æ§åº”ç”¨ç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¸®åŠ©åˆ†æåº”ç”¨è¡Œä¸ºã€‚                            | - ä¸éœ€è¦ä¿®æ”¹ç›®æ ‡ç¨‹åº<br>- ä¸æ˜“è¢«åº”ç”¨ç¨‹åºæ£€æµ‹<br>- æ€§èƒ½å¼€é”€ä½            |  
| **åº”ç”¨ç¨‹åºæ’æ¡©** | é€šè¿‡ kprobe/uprobe/tracepoints/USDT å¯¹åº”ç”¨ç¨‹åºè¿›è¡ŒåŠ¨æ€æ’æ¡©ï¼Œç”¨äºç›‘è§†æˆ–ä¿®æ”¹ç¨‹åºçŠ¶æ€ã€‚ | - é«˜åº¦ä¾¿æº<br>- æ— éœ€é‡æ–°ç¼–è¯‘åº”ç”¨ç¨‹åº<br>- æ”¯æŒå†…æ ¸å’Œç”¨æˆ·ç©ºé—´            |  
| **æ€§èƒ½é—®é¢˜åˆ†æ** | åˆ©ç”¨ eBPF ç›‘æ§å†…æ ¸å…³é”®è·¯å¾„ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆã€‚                                   | - ç›´æ¥åœ¨å†…æ ¸å±‚é¢å·¥ä½œï¼Œå‡å°‘å¹²æ‰°<br>- å¼€é”€ä½ï¼Œå‡†ç¡®æ€§é«˜<br>- æ˜“äºå®æ–½ï¼Œå·²æœ‰å·¥å…·æ”¯æŒ  |  
| **ç½‘ç»œæŠ“åŒ…**   | åœ¨å†…æ ¸ç½‘ç»œå±‚é¢ä¸Šä½¿ç”¨ eBPF å®ç°é«˜æ•ˆçš„æ•°æ®åŒ…æ•è·ï¼ŒåŒ…æ‹¬ HTTPS æµé‡ã€‚                    | - æ— éœ€è®¾ç½®ä»£ç†æˆ–ä½¿ç”¨å…¶ä»–ä¸­é—´ä»¶<br>- æ”¯æŒåŠ å¯†æµé‡çš„æ•è·ï¼ˆç†è®ºä¸Šï¼‰<br>- æ›´åŠ å®‰å…¨å¯é  |  
  
[ecapture](https://github.com/gojue/ecapture)  
[å®˜æ–¹æ¡ˆä¾‹](https://ecapture.cc/zh/examples/android.html)  
eCaptureä¸»è¦åˆ©ç”¨äº†eBPFå’ŒHOOKæŠ€æœ¯ï¼š  
- **eBPFåŠ è½½æœºåˆ¶**ï¼šåˆ©ç”¨eBPFæŠ€æœ¯è¿›è¡Œæ•°æ®åŒ…çš„æ•è·å’Œå¤„ç†ï¼ŒeBPFç¨‹åºæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œå½“å†…æ ¸æˆ–åº”ç”¨ç¨‹åºé€šè¿‡æŸä¸ªæŒ‚é’©ç‚¹æ—¶è¿è¡Œã€‚é¢„å®šä¹‰çš„é’©å­åŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€å‡½æ•°å…¥å£/å‡ºå£ã€å†…æ ¸è·Ÿè¸ªç‚¹ã€ç½‘ç»œäº‹ä»¶å’Œå…¶ä»–å‡ ä¸ªï¼›  
- **HOOKæœºåˆ¶**ï¼šä½¿ç”¨eBPF uprobeç›¸å…³å‡½æ•°è¿›è¡Œç”¨æˆ·æ€å‡½æ•°çš„HOOKï¼Œæ”¯æŒå¯¹ä¸åŒç¼–ç¨‹è¯­è¨€å®ç°çš„åŠ å¯†åº“è¿›è¡ŒHOOKï¼Œå¦‚OpenSSLã€GnuTLSã€NSS/NSPRã€‚  
  
eCapture çš„å·¥ä½œåŸç†æ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸æ€ã€‚ç”¨æˆ·æ€å°±æ˜¯è¿è¡Œåº”ç”¨ç¨‹åºçš„åœ°æ–¹ï¼Œæ¯”å¦‚å„ç§ Appã€‚åœ¨è¿™ä¸ªåŒºåŸŸä¸­ï¼ŒeCapture é€šè¿‡ä¸€ä¸ªå…±äº«çš„æ¨¡å—(Shared Object)è·å–åº”ç”¨ç¨‹åºçš„ç½‘ç»œæ•°æ®ã€‚ç„¶åï¼Œå®ƒå°†è¿™äº›æ•°æ®ä¼ é€’ç»™å†…æ ¸æ€çš„ eBPF ç¨‹åºè¿›è¡Œåˆ†æå’Œå¤„ç†ã€‚  
åœ¨å†…æ ¸ç©ºé—´ï¼ŒeCapture é€šè¿‡ eBPF æ’ä»¶æ•æ‰ç½‘ç»œå±‚çš„æ•°æ®æµï¼Œæ¯”å¦‚æ•°æ®åŒ…æ˜¯ä»å“ªé‡Œæ¥çš„ã€å‘åˆ°äº†å“ªé‡Œå»ã€‚è¿™ä¸€è¿‡ç¨‹ä¸éœ€è¦ä¿®æ”¹åº”ç”¨ç¨‹åºæœ¬èº«ï¼Œæ‰€ä»¥å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å¾ˆå°ã€‚  
![å›¾ç‰‡](_assets_24/51503d979edc786ef59d17daba088e824447.png)  
  
å®‰å“è®¾å¤‡çš„å†…æ ¸ç‰ˆæœ¬åªæœ‰åœ¨5.10ç‰ˆæœ¬ä¸Šæ‰å¯ä»¥è¿›è¡Œæ— ä»»ä½•ä¿®æ”¹çš„å¼€ç®±æŠ“åŒ…æ“ä½œ(å¦‚æœä½ çš„è®¾å¤‡æ˜¯å®‰å“13ï¼Œåº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨ecaptureã€‚ä½äº13çš„å®‰å“è®¾å¤‡ï¼Œå¦‚æœå†…æ ¸æ˜¯5.10ï¼Œç†è®ºä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ å› ä¸ºå®‰å“ä½¿ç”¨çš„linuxå†…æ ¸çš„ebpfç¯å¢ƒå—å†…æ ¸ç‰ˆæœ¬å·çš„å½±å“ï¼Œè€Œå·¥ä½œè‰¯å¥½çš„ebpfæ¥å£æ˜¯åœ¨å†…æ ¸5.5ç‰ˆæœ¬æ—¶æ‰å…¨éƒ¨ä½¿èƒ½ã€‚)  
å¯é€šè¿‡adbå‘½ä»¤æŸ¥çœ‹è‡ªå·±çš„è®¾å¤‡çš„å†…æ ¸ç‰ˆæœ¬  
```  
adb shell cat /proc/version  
æˆ–è€…adb shell uname -a  
```  
[ä¸‹è½½åœ°å€](https://github.com/gojue/ecapture/releases)  
```  
adb push ecapture /data/local/tmp/  
adb shell chmod 777 /data/local/tmp/ecapture  
```  
`ä½¿ç”¨è¯´æ˜`  
```  
NAME:  
        eCapture - é€šè¿‡eBPFæ•è·SSL/TLSæ˜æ–‡æ•°æ®ï¼Œæ— éœ€å®‰è£…CAè¯ä¹¦ã€‚æ”¯æŒLinux/Androidå†…æ ¸ï¼Œé€‚ç”¨äºamd64/arm64æ¶æ„ã€‚  
  
USAGE:  
        eCapture [flags]  
  
VERSION:  
        androidgki_arm64:v0.8.9:6.5.0-1025-azure  
  
COMMANDS:  
        bash    æ•è·bashå‘½ä»¤çš„æ‰§è¡Œä¿¡æ¯  
        gotls   æ•è·ä½¿ç”¨TLS/HTTPSåŠ å¯†çš„Golangç¨‹åºçš„æ˜æ–‡é€šä¿¡  
        help    è·å–æœ‰å…³ä»»ä½•å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯  
        tls     ç”¨äºæ•è·TLS/SSLæ˜æ–‡å†…å®¹ï¼Œæ— éœ€CAè¯ä¹¦ã€‚æ”¯æŒOpenSSL 1.0.x/1.1.x/3.xæˆ–æ›´æ–°ç‰ˆæœ¬ã€‚  
  
DESCRIPTION:  
        eCaptureï¼ˆæ—è§‚è€…ï¼‰æ˜¯ä¸€ä¸ªå¯ä»¥æ•è·å¦‚HTTPSå’ŒTLSç­‰æ˜æ–‡æ•°æ®åŒ…çš„å·¥å…·ï¼Œä¸”ä¸éœ€è¦å®‰è£…CAè¯ä¹¦ã€‚  
        å®ƒè¿˜å¯ä»¥æ•è·bashå‘½ä»¤ï¼Œé€‚ç”¨äºå®‰å…¨å®¡è®¡åœºæ™¯ï¼Œæ¯”å¦‚mysqldæ•°æ®åº“å®¡è®¡ç­‰ï¼ˆåœ¨Androidä¸­ç¦ç”¨ï¼‰ã€‚  
        æ”¯æŒLinux(Android)ç³»ç»Ÿï¼Œå†…æ ¸ç‰ˆæœ¬ä¸ºX86_64 4.18æˆ–aarch64 5.5åŠæ›´é«˜ç‰ˆæœ¬ã€‚  
        é¡¹ç›®ä»“åº“ï¼šhttps://github.com/gojue/ecapture  
        å®˜æ–¹ä¸»é¡µï¼šhttps://ecapture.cc  
  
        ä½¿ç”¨æ–¹æ³•ï¼š  
          ecapture tls -h  
          ecapture bash -h  
  
        Dockerä½¿ç”¨ç¤ºä¾‹ï¼š  
        docker pull gojue/ecapture:latest  
        docker run --rm --privileged=true --net=host -v ${HOST_PATH}:${CONTAINER_PATH} gojue/ecapture -h  
  
NAME:  
        tls - ç”¨äºæ•è·TLS/SSLæ˜æ–‡å†…å®¹ï¼Œæ— éœ€CAè¯ä¹¦ã€‚æ”¯æŒOpenSSL 1.0.x/1.1.x/3.xåŠæ›´æ–°ç‰ˆæœ¬ã€‚  
  
USAGE:  
        eCapture tls [flags]  
  
DESCRIPTION:  
        ä½¿ç”¨eBPF uprobe/TCæ•è·è¿›ç¨‹äº‹ä»¶æ•°æ®å’Œç½‘ç»œæ•°æ®ã€‚è¿˜æ”¯æŒpcap-NGæ ¼å¼ã€‚  
  
        ç¤ºä¾‹ï¼š  
        ecapture tls -m [text|keylog|pcap] [flags] [pcapè¿‡æ»¤è¡¨è¾¾å¼ï¼ˆç”¨äºpcapæ¨¡å¼ï¼‰]  
        ecapture tls -m pcap -i wlan0 -w save.pcapng host 192.168.1.1 and tcp port 443  
        ecapture tls -l save.log --pid=3423  
        ecapture tls --libssl=/lib/x86_64-linux-gnu/libssl.so.1.1  
        ecapture tls -m keylog --pcapfile save_3_0_5.pcapng --ssl_version="openssl 3.0.5" --libssl=/lib/x86_64-linux-gnu/libssl.so.3  
        ecapture tls -m pcap --pcapfile save_android.pcapng -i wlan0 --libssl=/apex/com.android.conscrypt/lib64/libssl.so --ssl_version="boringssl 1.1.1" tcp port 443  
  
        Dockerä½¿ç”¨ç¤ºä¾‹ï¼š  
        docker pull gojue/ecapture  
        docker run --rm --privileged=true --net=host -v /etc:/etc -v /usr:/usr -v ${PWD}:/output gojue/ecapture tls -m pcap -i wlp3s0 --pcapfile=/output/ecapture.pcapng tcp port 443  
  
OPTIONS:  
      --cgroup_path="/sys/fs/cgroup"            è®¾ç½®cgroupè·¯å¾„ï¼Œé»˜è®¤å€¼ï¼š/sys/fs/cgroupã€‚  
  -h, --help[=false]                            è·å–tlså‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯  
  -i, --ifname=""                               (TC Classifier) è¦é™„åŠ æ¢é’ˆçš„ç½‘ç»œæ¥å£åç§°  
  -k, --keylogfile="ecapture_openssl_key.og"    å­˜å‚¨SSL/TLSå¯†é’¥çš„æ–‡ä»¶ï¼ŒeCaptureæ•è·åŠ å¯†é€šä¿¡ä¸­çš„å¯†é’¥å¹¶å°†å…¶ä¿å­˜åˆ°è¯¥æ–‡ä»¶  
      --libssl=""                               æŒ‡å®šlibssl.soæ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä»curlä¸­è‡ªåŠ¨æŸ¥æ‰¾  
  -m, --model="text"                            æ•è·æ¨¡å‹ï¼Œå¯ä»¥æ˜¯ï¼štextï¼ˆæ˜æ–‡å†…å®¹ï¼‰ï¼Œpcap/pcapngï¼ˆåŸå§‹æ•°æ®åŒ…æ ¼å¼ï¼‰ï¼Œkey/keylogï¼ˆSSL/TLSå¯†é’¥ï¼‰  
  -w, --pcapfile="save.pcapng"                  å°†åŸå§‹æ•°æ®åŒ…ä»¥pcapngæ ¼å¼å†™å…¥æ–‡ä»¶  
      --ssl_version=""                          æŒ‡å®šOpenSSL/BoringSSLç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š--ssl_version="openssl 1.1.1g" æˆ– --ssl_version="boringssl 1.1.1"  
  
GLOBAL OPTIONS:  
  -b, --btf=0                           å¯ç”¨BTFæ¨¡å¼ï¼ˆ0ï¼šè‡ªåŠ¨é€‰æ‹©ï¼›1ï¼šæ ¸å¿ƒæ¨¡å¼ï¼›2ï¼šéæ ¸å¿ƒæ¨¡å¼ï¼‰  
  -d, --debug[=false]                   å¯ç”¨è°ƒè¯•æ—¥å¿—  
      --eventaddr=""                    è®¾ç½®æ¥æ”¶æ•è·äº‹ä»¶çš„æœåŠ¡å™¨åœ°å€ã€‚é»˜è®¤å€¼ä¸logaddrç›¸åŒï¼ˆä¾‹å¦‚ï¼štcp://127.0.0.1:8090ï¼‰  
      --hex[=false]                     ä»¥åå…­è¿›åˆ¶å­—ç¬¦ä¸²æ‰“å°å­—èŠ‚æ•°æ®  
      --listen="localhost:28256"        è®¾ç½®HTTPæœåŠ¡å™¨çš„ç›‘å¬åœ°å€ï¼Œé»˜è®¤å€¼ï¼š127.0.0.1:28256  
  -l, --logaddr=""                      è®¾ç½®æ—¥å¿—æœåŠ¡å™¨çš„åœ°å€ã€‚ä¾‹å¦‚ï¼š-l /tmp/ecapture.log æˆ– -l tcp://127.0.0.1:8080  
      --mapsize=1024                    è®¾ç½®æ¯ä¸ªCPUçš„eBPFæ˜ å°„å¤§å°ï¼ˆäº‹ä»¶ç¼“å†²åŒºï¼‰ã€‚é»˜è®¤å€¼ï¼š1024 * PAGESIZEï¼ˆå•ä½ï¼šKBï¼‰  
  -p, --pid=0                           è®¾ç½®ç›®æ ‡è¿›ç¨‹IDã€‚å¦‚æœä¸º0ï¼Œåˆ™ç›®æ ‡ä¸ºæ‰€æœ‰è¿›ç¨‹  
  -u, --uid=0                           è®¾ç½®ç›®æ ‡ç”¨æˆ·IDã€‚å¦‚æœä¸º0ï¼Œåˆ™ç›®æ ‡ä¸ºæ‰€æœ‰ç”¨æˆ·  
  
```  
  
```  
adb shell ps | findstr åº”ç”¨åŒ…åï¼ˆè·å–è¿›ç¨‹pidï¼‰  
./ecapture tls -p pid -m text  
```  
  
## 4.ç®€å•åŠ è§£å¯†åè®®å®æˆ˜  
è¯´ä¸€ä¸‹è¿™é‡ŒæœåŠ¡ç«¯é…ç½®éœ€è¦é€šè¿‡ipconfigè·å–åˆ°çœŸå®çš„ipåœ°å€æ›¿æ¢ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦å¯¹æ•™ç¨‹demoé‡Œçš„dexè¿›è¡Œä¿®æ”¹ï¼Œå­—ç¬¦ä¸²æœæœ192.ï¼Œç„¶åæŠŠå¯¹åº”æ¥å£çš„ipåœ°å€æ¢æˆåˆšæ‰è·å–åˆ°çš„ipåœ°å€  
`æœåŠ¡ç«¯ä»£ç :`  
```python  
import hashlib  
import json  
import base64  
import time  
from Crypto.Cipher import AES  
from Crypto.Util.Padding import pad  
from cryptography.hazmat.primitives import padding  
from flask import Flask, jsonify, request  
  
app = Flask(__name__)  
  
  
# åŠ å¯†å‡½æ•°  
def aes_encrypt(data: str) -> str:  
    key = b'1234567890abcdefwuaipojie0abcdef'  
    iv = b'1234567wuaipojie'  # Initialization Vector  
    cipher = AES.new(key, AES.MODE_CBC, iv)  
    encrypted_data = cipher.encrypt(pad(data.encode('utf-8'), AES.block_size))  
    return base64.b64encode(encrypted_data).decode('utf-8')  
  
# è§£å¯†å‡½æ•°  
def aes_decrypt(encrypted_data: str) -> dict:  
    key = b'1234567890abcdefwuaipojie0abcdef'  
    iv = b'1234567wuaipojie'  # Initialization Vector  
    cipher = AES.new(key, AES.MODE_CBC, iv)  
    encrypted_bytes = base64.b64decode(encrypted_data)  
    decrypted_data = cipher.decrypt(encrypted_bytes)  
    unpadder = padding.PKCS7(AES.block_size * 8).unpadder()  
    decrypted_unpadded = unpadder.update(decrypted_data) + unpadder.finalize()  
    decrypted_str = decrypted_unpadded.decode('utf-8')  
    return json.loads(decrypted_str)  
  
# è¯»å–ç”¨æˆ·æ•°æ®  
with open('user_data.json', 'r') as file:  
    user_data = json.load(file)  
  
# å†™å…¥æœ¬åœ°JSONæ–‡ä»¶  
def write_json_file(file_path: str, data: dict):  
    with open(file_path, 'w') as file:  
        json.dump(data, file, indent=4)  
  
# ç”Ÿæˆç­¾åå‡½æ•°  
def generate_signature(user_id: str, coin: int, timestamp: int) -> str:  
    message = f"{user_id}&{coin}&{timestamp}"  
    hash_object = hashlib.md5(message.encode())  
    return hash_object.hexdigest()  
  
  
@app.route('/get_coin', methods=['POST'])  
def get_coin():  
    # è·å–åŠ å¯†çš„æ•°æ®  
    encrypted_data = request.json.get('user_data')  
    if not encrypted_data:  
        return jsonify({"error": "æ•°æ®æœ‰è¯¯!"}), 400  
    try:  
        # è§£å¯†æ•°æ®  
        decrypted_data = aes_decrypt(encrypted_data)  
        # éªŒè¯ç­¾å  
        timestamp = int(decrypted_data.get('timestamp'))  
        current_time = int(time.time()*1000)  
        print(timestamp)  
        print(abs(current_time - timestamp))  
        if abs(current_time - timestamp) > 5000:  
            return jsonify({"error": "è¯·æ±‚è¿‡æœŸ!"}), 400  
        sign = decrypted_data.get('sign')  
        # è®¡ç®—ç­¾å  
        expected_sign = generate_signature(decrypted_data["user_id"], 1, timestamp)  
        if sign != expected_sign:  
            return jsonify({"error": "ç­¾åéªŒè¯å¤±è´¥!"}), 401  
        # éªŒè¯æˆåŠŸåï¼Œè·å–ç”¨æˆ·çš„é‡‘å¸æ•°é‡  
        user_id = decrypted_data.get('user_id')  
        if user_id in user_data['user_id']:  
            user_data['coin_amount'] += 1  # å¢åŠ é‡‘å¸æ•°é‡  
            write_json_file('user_data.json', user_data)  # å†™å…¥æ–‡ä»¶  
            return jsonify({"æŠ•å¸æˆåŠŸï¼Œå½“å‰æ•°é‡ä¸º:": user_data['coin_amount']})  
        else:  
            return jsonify({"error": "ç”¨æˆ·æœªæ‰¾åˆ°!"}), 404  
    except Exception as e:  
        return jsonify({"error": f"å¤„ç†è¯·æ±‚æ—¶å‡ºé”™: {str(e)}"}), 500  
  
@app.route('/get_user_data', methods=['GET'])  
def get_user_data():  
    # å°†æ•°æ®è½¬æ¢æˆå­—ç¬¦ä¸²å½¢å¼ä»¥ä¾¿äºåŠ å¯†  
    data_str = json.dumps(user_data)  
    return jsonify({"user_data": data_str})  
  
if __name__ == '__main__':  
    app.run(host='192.168.73.82', port=5000)  
```  
  
`åè®®å®ç°:`  
```python  
import json  
import base64  
import hashlib  
import time  
  
from Crypto.Cipher import AES  
from Crypto.Util.Padding import pad  
from datetime import datetime  
import requests  
  
# ç”Ÿæˆç­¾åå‡½æ•°  
def generate_signature(user_id: str, coin: int, timestamp: int) -> str:  
    message = f"{user_id}&{coin}&{timestamp}"  
    hash_object = hashlib.md5(message.encode())  
    return hash_object.hexdigest()  
  
# åŠ å¯†å‡½æ•°  
def aes_encrypt(data: str) -> str:  
    key = b'1234567890abcdefwuaipojie0abcdef'  
    iv = b'1234567wuaipojie'  # Initialization Vector  
    cipher = AES.new(key, AES.MODE_CBC, iv)  
    encrypted_data = cipher.encrypt(pad(data.encode('utf-8'), AES.block_size))  
    return base64.b64encode(encrypted_data).decode('utf-8')  
  
# æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®  
user_data = {  
    "user_id": "zj2595",  
    "timestamp": int(time.time()*1000),  # å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³  
    "sign": "",  # è¿™ä¸ªç¨åè®¡ç®—å¹¶èµ‹å€¼  
}  
  
# è®¡ç®—ç­¾å  
user_data["sign"] = generate_signature(user_data["user_id"], 1, user_data["timestamp"])  
  
# è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²  
data_str = json.dumps(user_data)  
  
# åŠ å¯†æ•°æ®  
encrypted_data = aes_encrypt(data_str)  
  
# å‘é€POSTè¯·æ±‚  
try:  
    response = requests.post(  
        'http://192.168.73.82:5000/get_coin',  
        json={"user_data": encrypted_data},  
  
    )  
    if response.status_code == 200:  
        print("æŠ•å¸æˆåŠŸ")  
        print("Response:", response.json())  
    else:  
        print(f"Request failed with status code: {response.status_code}")  
except requests.exceptions.RequestException as e:  
    print(f"è¯·æ±‚å‡ºç°å¼‚å¸¸: {e}")  
```  
# å››ã€è¯·ä½œè€…å–æ¯å’–å•¡  
![å›¾ç‰‡](_assets_24/0595862b33c3749fe0addb56298b2e092560.png)  
  
# å…­ã€è§†é¢‘åŠè¯¾ä»¶åœ°å€  
  
  
[ç™¾åº¦äº‘](https://pan.baidu.com/s/1cFWTLn14jeWfpXxlx3syYw?pwd=nqu9)  
[é˜¿é‡Œäº‘](https://www.aliyundrive.com/s/TJoKMK6du6x)  
[å“”å“©å“”å“©](https://www.bilibili.com/video/BV1wT411N7sV/?spm_id_from=333.788&vd_source=6dde16dc6479f00694baaf73a2225452)  
[æ•™ç¨‹å¼€æºåœ°å€](https://github.com/ZJ595/AndroidReverse)  
PS:è§£å‹å¯†ç éƒ½æ˜¯52pjï¼Œé˜¿é‡Œäº‘ç”±äºä¸èƒ½åˆ†äº«å‹ç¼©åŒ…ï¼Œæ‰€ä»¥ä¸‹è½½exeæ–‡ä»¶ï¼ŒåŒå‡»è‡ªè§£å‹  
  
# ä¸ƒã€å…¶ä»–ç« èŠ‚  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ä¸€ã€æ¨¡æ‹Ÿå™¨ç¯å¢ƒæ­å»º](https://www.52pojie.cn/thread-1695141-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹äºŒã€åˆè¯†APKæ–‡ä»¶ç»“æ„ã€åŒå¼€ã€æ±‰åŒ–ã€åŸºç¡€ä¿®æ”¹](https://www.52pojie.cn/thread-1695796-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ä¸‰ã€åˆè¯†smailï¼Œvipç»ˆç»“è€…](https://www.52pojie.cn/thread-1701353-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹å››ã€æ­å–œä½ è·å¾—å¹¿å‘Š&å¼¹çª—é™é»˜å¡](https://www.52pojie.cn/thread-1706691-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹äº”ã€1000-7=ï¼Ÿ&åŠ¨æ€è°ƒè¯•&Logæ’æ¡©](https://www.52pojie.cn/thread-1714727-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹å…­ã€æ ¡éªŒçš„Næ¬¡æ–¹-ç­¾åæ ¡éªŒå¯¹æŠ—ã€PMä»£{è¿‡}{æ»¤}ç†ã€IOé‡å®šå‘](https://www.52pojie.cn/thread-1731181-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ä¸ƒã€Sorryï¼Œä¼šHookçœŸçš„å¯ä»¥ä¸ºæ‰€æ¬²ä¸º-Xposedå¿«é€Ÿä¸Šæ‰‹(ä¸Š)æ¨¡å—ç¼–å†™,å¸¸ç”¨Api](https://www.52pojie.cn/thread-1740944-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹å…«ã€Sorryï¼Œä¼šHookçœŸçš„å¯ä»¥ä¸ºæ‰€æ¬²ä¸º-xposedå¿«é€Ÿä¸Šæ‰‹(ä¸‹)å¿«é€Ÿhook](https://www.52pojie.cn/thread-1748081-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ä¹ã€å¯†ç å­¦åŸºç¡€ã€ç®—æ³•è‡ªåã€éæ ‡å‡†åŠ å¯†å¯¹æŠ—](https://www.52pojie.cn/thread-1762225-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åã€ä¸æ˜¯æˆ‘è¯´ï¼Œæœ‰äº†IDAè¿˜è¦ä»€ä¹ˆå¥³æœ‹å‹ï¼Ÿ](https://www.52pojie.cn/thread-1787667-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åäºŒã€å¤§ä½¬å¸®æˆ‘åˆ†æä¸€ä¸‹](https://www.52pojie.cn/thread-1809646-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ç•ªå¤–å®æˆ˜ç¯‡1-æŸç”µå½±è§†å…¨å®¶æ¡¶](https://www.52pojie.cn/thread-1814917-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åä¸‰ã€æ˜¯æ—¶å€™å­¦ä¹ ä¸€ä¸‹Fridaä¸€æŠŠæ¢­äº†(ä¸Š)](https://www.52pojie.cn/thread-1823118-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åå››ã€æ˜¯æ—¶å€™å­¦ä¹ ä¸€ä¸‹Fridaä¸€æŠŠæ¢­äº†(ä¸­)](https://www.52pojie.cn/thread-1838539-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åäº”ã€æ˜¯æ—¶å€™å­¦ä¹ ä¸€ä¸‹Fridaä¸€æŠŠæ¢­äº†(ä¸‹)](https://www.52pojie.cn/thread-1840174-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åå…­ã€æ˜¯æ—¶å€™å­¦ä¹ ä¸€ä¸‹Fridaä¸€æŠŠæ¢­äº†(ç»ˆ)](https://www.52pojie.cn/thread-1859820-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åä¸ƒã€ä½ çš„RPCvsä½¬çš„RPC](https://www.52pojie.cn/thread-1892127-1-1.html#/)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ç•ªå¤–å®æˆ˜ç¯‡2-ã€2024æ˜¥èŠ‚ã€‘è§£é¢˜é¢†çº¢åŒ…æ´»åŠ¨ï¼Œå¯åŠ¨!](https://www.52pojie.cn/thread-1893708-1-1.html#/)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åå…«ã€è¡¨å“¥ï¼Œä½ ä¹Ÿä¸æƒ³ä½ çš„Fridaè¢«æ£€æµ‹å§!(ä¸Š)](https://www.52pojie.cn/thread-1921073-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹åä¹ã€è¡¨å“¥ï¼Œä½ ä¹Ÿä¸æƒ³ä½ çš„Fridaè¢«æ£€æµ‹å§!(ä¸‹)](https://www.52pojie.cn/thread-1938862-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹äºŒåã€æŠ“åŒ…å­¦å¾—å¥½ï¼Œç‰¢é¥­åƒå¾—é¥±(ä¸Š)](https://www.52pojie.cn/thread-1945285-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ç•ªå¤–å®æˆ˜ç¯‡3-æ‹¨äº‘è§æ—¥ä¹‹æµ…è°ˆFlutteré€†å‘](https://www.52pojie.cn/thread-1951619-1-1.html)  
[ã€Šå®‰å“é€†å‘è¿™æ¡£äº‹ã€‹ç¬¬äºŒåä¸€è¯¾ã€æŠ“åŒ…å­¦å¾—å¥½ï¼Œç‰¢é¥­åƒå¾—é¥±(ä¸­)](https://www.52pojie.cn/thread-1967845-1-1.html)  
  
# å…«ã€å‚è€ƒæ–‡æ¡£  
[ç‚’å†·é¥­æ±‡æ€»æŠ“åŒ…å§¿åŠ¿-ä¸Š](https://bbs.kanxue.com/thread-278142.htm)  
[å®‰å“ App é€†å‘è¯¾ç¨‹ä¹‹å›› frida æ³¨å…¥ Okhttp æŠ“åŒ…ä¸­ç¯‡](https://cloud.tencent.com/developer/article/1663828)  
  
